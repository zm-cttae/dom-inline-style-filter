(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.dominlinestylefilter = factory());
})(this, (function () { 'use strict';

	const contentElement=globalThis.document.body||globalThis.document.documentElement,cssBlockCommentRegex=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g,cssDeclarationColonRegex=/;\s*(?=-*\w+(?:-\w+)*:\s*(?:[^"']*["'][^"']*["'])*[^"']*$)/g;let removeDefaultStylesTimeoutId=null,tagNameDefaultStyles={};const ascentStoppers=new Set(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DETAILS","DIALOG","DD","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","SVG","TABLE","UL","math","RUBY","svg","BODY","HEAD","HTML"]),dominlinestylefilter=function(e,t){const n=new Context(e,t||{});return new Promise(stageCloneWith(n)).then(collectTree).then(sortAscending).then(multiPassFilter).then(unstageClone)};dominlinestylefilter.sync=function(e,t){const n=new Context(e,t||{});try{let e=execute(stageCloneWith(n));return [collectTree,sortAscending,multiPassFilter,unstageClone].forEach((function(t){e=t(e);})),e}catch(e){throw unstageClone(n),e}};var src=dominlinestylefilter;function Context(e,t){this.root=e,this.sibling=e.nextSibling,this.parent=e.parentElement,this.sandbox=null,this.self=null,this.tree=null,this.stack=[],this.pyramid=null,this.cutoff=null,this.declarations=null,this.bytes=null,this.depths=[],this.depth=null,this.delta=null,this.options=t,this.options.debug=t.debug||!1;}function Styles(e,t){this.context=e,this.element=t,this.inline=t.style,this.computed=e.self.getComputedStyle(t);}function execute(e){let t;return e((e=>{t=e;}),(e=>{throw new Error(e)})),t}function createSandbox(){const e=globalThis.document.createElementNS("http://www.w3.org/1999/xhtml","iframe");e.id="dominlinestylefilter-sandbox-"+(Math.floor(9e3*Math.random())+1e3),e.style.visibility="hidden",e.style.position="fixed",e.style.width="100vw",e.style.height="100vh";const t=globalThis.document.characterSet||"UTF-8",n=globalThis.document.doctype,o=n?`<!DOCTYPE ${i(n.name)} ${i(n.publicId)} ${i(n.systemId)}`.trim()+">":"";return contentElement.appendChild(e),function(e,t,n,o){try{return e.contentWindow.document.write(`${t}<html><head><meta charset='${n}'><title>${o}</title></head><body></body></html>`),e}catch(e){}const i=globalThis.document.createElement("meta");i.setAttribute("charset",n);try{const n=globalThis.document.implementation.createHTMLDocument(o);n.head.appendChild(i);const l=t+n.documentElement.outerHTML;return e.setAttribute("srcdoc",l),e}catch(e){}return e.contentDocument.head.appendChild(i),e.contentDocument.title=o,e}(e,o,t,e.id);function i(e){if(e){const t=globalThis.document.createElement("div");return t.innerText=e,t.innerHTML}return ""}}function getDefaultStyle(e,t){const n=function(e){const t=[e.tagName];if(ascentStoppers.has(e.tagName))return t;let n=e;for(;n=n.parentNode;)if(n.nodeType===globalThis.Node.ELEMENT_NODE){const e=n.tagName;if(t.push(e),ascentStoppers.has(e))break}return t}(t),o=n.filter(((e,t,n)=>0===t||t===n.length-1)).join(" ");if(tagNameDefaultStyles[o])return tagNameDefaultStyles[o];const i=function(e,t){let n=e.body;for(;t.length>0;){const o=t.pop(),i=e.createElement(o);n.appendChild(i),n=i;}return n.textContent="â€‹",n}(e.self.document,n),l=function(e,t){const n={},o=e.getComputedStyle(t);return Array.from(o).forEach((function(e){n[e]="width"===e||"height"===e?"auto":o.getPropertyValue(e);})),n}(e.self,i);return function(e){let t=e,n=e.parentElement;for(;t&&"BODY"!==t.tagName;)n=t.parentElement,null!==n&&n.removeChild(t),t=n;}(i),tagNameDefaultStyles[o]=l,l}function stageCloneWith(e){return (t,n)=>{e.sandbox=createSandbox(),e.self=e.sandbox.contentWindow,e.self.document.body.appendChild(e.root),e.sandbox.parentElement||n("failed to append sandbox iframe to DOM"),t(e);}}function collectTree(e){const t=e.self.document.createTreeWalker(e.root,globalThis.NodeFilter.SHOW_ELEMENT);e.cutoff=e.depth=1,e.tree=[e.root],e.depths=[e.depth],e.stack=[],e.pyramid=[],e.declarations=e.root.style.length,e.bytes=e.root.style.cssText.length;let n,o=0;for(;n=t.nextNode();){o+=1,e.tree.push(n);const t=getDepth.call(e,n,o);e.depths.push(t),e.declarations+=n.style.length,e.bytes+=n.style.cssText.length;}return e}function sortAscending(e){for(let t=e.cutoff;t>0;t--)for(let n=0;n<e.tree.length;n++)e.depths[n]===t&&e.pyramid.push(e.tree[n]);return e.tree=null,e}function getDepth(e,t){const n=this,o=n.tree[t-1]||null;if(e.parentElement===o)return n.depth+=1,n.stack.push(t-1),n.depth>n.cutoff&&(n.cutoff=n.depth),n.depth;if(e.previousElementSibling===o)return n.depth;for(let t=n.stack.length;t>=0;t--){const o=n.stack[t];n.tree[o]===e.parentElement&&(n.depth=n.depths[o]+1,n.stack=n.stack.slice(0,t+1));}return n.depth}function multiPassFilter(e){let t,n=0;for(e.pyramid.forEach(stripBlockComments),e.root.querySelectorAll("style").forEach(filterWinningMediaQueries),e.options.debug&&(t=debugFilterAuthorInlineStyles(e)),Math.round(Math.log2(e.declarations/e.pyramid.length))>=6&&(e.pyramid.forEach(filterAuthorInlineStyles.bind(null,e)),e.options.debug&&debugFilterAuthorInlineStyles(e,t)),e.options.debug&&(t=debugFilterWinningInlineStyles(e,null,n));0!==e.delta;)e.delta=0,e.pyramid.forEach(filterWinningInlineStyles.bind(null,e)),e.options.debug&&(n+=1,debugFilterWinningInlineStyles(e,null,n));return e.options.debug&&debugFilterWinningInlineStyles(e,t),e}const roundTo3dp=e=>Math.round(1e3*e)/1e3;function debugFilterAuthorInlineStyles(e,t){if(!t)return console.info("filterAuthorInlineStyles"),console.info("context.pyramid.length",e.pyramid.length),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),performance.now();console.info("filterAuthorInlineStyles"),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),console.info("runtime(ms)",roundTo3dp(performance.now()-t));}function debugFilterWinningInlineStyles(e,t,n){if(0===n)return console.info("filterWinningInlineStyles"),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),performance.now();n?console.info("filterWinningInlineStyles","pass #"+n):(console.info("filterWinningInlineStyles"),console.info("runtime(ms)",roundTo3dp(performance.now()-t))),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),console.info("context.delta",e.delta);}function stripBlockComments(e){const t=e.getAttribute("style");cssBlockCommentRegex.test(t)&&e.setAttribute("style",t.replace(cssBlockCommentRegex,""));}function filterWinningMediaQueries(e){if(e.media&&!globalThis.matchMedia(e.media).matches)return void e.parentElement.removeChild(e);if(!e.textContent.includes("@media"))return;const t=/@media([^{]+)\{((?:(?!\}\s*\})[\s\S])*\})\s*\}/;let n;for(;n=t.exec(e.textContent);){const t=n[1].trim(),o=n[2].trim();globalThis.matchMedia(t).matches?e.textContent=e.textContent.replace(n[0],o):e.textContent=e.textContent.replace(n[0],"");}}function filterAuthorInlineStyles(e,t){if(!t.attributes.style)return;const n=new Styles(e,t),o=n.inline.cssText.length;e.bytes-=o;const i=freezeStyleAnimations(n),l=t!==e.root?e.self.getComputedStyle(t.parentElement):null,s=getDefaultStyle(e,t);Array.from(n.inline).sort(compareHyphenCount).forEach(spliceAuthorCssStyleDeclaration.bind(null,n,l,s)),unfreezeStyleAnimations(n,i);const r=n.inline.cssText.length;e.bytes+=r;}function filterWinningInlineStyles(e,t){if(!t.attributes.style)return;const n=new Styles(e,t),o=n.inline.cssText.length;e.bytes-=o,e.delta+=o;const i=freezeStyleAnimations(n);tokenizeCssTextDeclarations(n.inline.cssText).map(getCssTextProperty).sort(compareHyphenCount).forEach(spliceWinningCssTextDeclaration.bind(null,n)),unfreezeStyleAnimations(n,i);const l=n.inline.cssText.length;e.bytes+=l,e.delta-=l,""===t.getAttribute("style")&&t.removeAttribute("style");}function freezeStyleAnimations(e){let t=!1;const n={"animation-duration":null,"transition-duration":null};for(const o in n){if(!Object.prototype.hasOwnProperty.call(n,o))continue;const i=e.inline.getPropertyValue(o);i&&(["auto","0s"].includes(i)?e.inline.removeProperty(o):(t=!0,n[o]=i,e.inline.setProperty(o,"0s")));}return t?n:void 0}function unfreezeStyleAnimations(e,t){if(t)for(const n in t)t[n].length&&e.inline.setProperty(n,t[n]);}function tokenizeCssTextDeclarations(e){return e.replace(/;\s*$/,"").split(cssDeclarationColonRegex)}function getCssTextProperty(e){return e.slice(0,e.indexOf(":"))}function compareHyphenCount(e,t){const n=e=>/^--\b/.test(e),o=e=>/^-\b/.test(e);return n(e)&&!n(t)?1:!n(e)&&n(t)?-1:o(e)&&!o(t)?1:!o(e)&&o(t)?-1:t.split("-").length-e.split("-").length}function spliceAuthorCssStyleDeclaration(e,t,n,o){if("width"===o||"height"===o)return;const i=e.inline.getPropertyValue(o),l=n[o],s=t?t.getPropertyValue(o):void 0;l&&i===l&&(!s||t&&i===s)&&(e.inline.removeProperty(o),e.context.declarations-=1);}function spliceWinningCssTextDeclaration(e,t){if("width"===t||"height"===t)return;if("animation-duration"===t||"transition-duration"===t)return;const n=e.inline.getPropertyValue(t),o=tokenizeCssTextDeclarations(e.inline.cssText),i=o.findIndex((e=>t===getCssTextProperty(e)));-1!==i&&(e.inline.cssText=o.filter(((e,t)=>t!==i)).join("; ")+";",n===e.computed.getPropertyValue(t)?e.context.declarations-=1:e.inline.cssText=o.join("; ")+";");}function unstageClone(e){return e.parent&&e.parent.insertBefore(e.root,e.sibling),e.sandbox&&e.sandbox.parentElement&&contentElement.removeChild(e.sandbox),e.sandbox&&(e.self=null,e.sandbox=null),removeDefaultStylesTimeoutId&&clearTimeout(removeDefaultStylesTimeoutId),removeDefaultStylesTimeoutId=setTimeout((()=>{removeDefaultStylesTimeoutId=null,tagNameDefaultStyles={};}),2e4),e.root}

	return src;

}));
