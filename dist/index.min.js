(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.dominlinestylefilter = factory());
})(this, (function () { 'use strict';

	const contentElement=globalThis.document.body||globalThis.document.documentElement,cssBlockCommentRegex=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g,cssDeclarationColonRegex=/;\s*(?=-*\w+(?:-\w+)*:\s*(?:[^"']*["'][^"']*["'])*[^"']*$)/g,dominlinestylefilter=function(t){const e=new Context(t);return new Promise(stageCloneWith(e)).then(collectTree).then(sortAscending).then(multiPassFilter).then(unstageClone)};dominlinestylefilter.sync=function(t){const e=new Context(t);try{let t=execute(stageCloneWith(e));return [collectTree,sortAscending,multiPassFilter,unstageClone].forEach((function(e){t=e(t);})),t}catch(t){throw unstageClone(e),t}};var src=dominlinestylefilter;function Context(t){this.root=t,this.sibling=t.nextSibling,this.parent=t.parentElement,this.sandbox=null,this.self=null,this.tree=null,this.stack=[],this.pyramid=null,this.cutoff=null,this.depths=[],this.depth=null,this.delta=null;}function Styles(t,e){this.inline=t.style,this.computed=e.sandbox.contentWindow.getComputedStyle(t);}function execute(t){let e;return t((t=>{e=t;}),(t=>{throw new Error(t)})),e}function createSandbox(){const t=globalThis.document.createElementNS("http://www.w3.org/1999/xhtml","iframe");t.style.visibility="hidden",t.style.position="fixed",t.style.width="100vw",t.style.height="100vh",t.sandbox.add("allow-same-origin"),contentElement.appendChild(t);const e=t.contentDocument.createElement("meta");return e.setAttribute("charset",globalThis.document.characterSet||"UTF-8"),t.contentDocument.head.appendChild(e),t.contentDocument.title=t.id="dominlinestylefilter-sandbox",t}function stageCloneWith(t){return (e,n)=>{t.sandbox=createSandbox(),t.self=t.sandbox.contentWindow,t.self.document.body.appendChild(t.root),t.sandbox.parentElement||n("failed to append sandbox iframe to DOM"),e(t);}}function collectTree(t){const e=t.self.document.createTreeWalker(t.root,globalThis.NodeFilter.SHOW_ELEMENT);t.cutoff=t.depth=1,t.tree=[t.root],t.depths=[t.depth],t.stack=[],t.pyramid=[];let n,i=0;for(;n=e.nextNode();){i+=1,t.tree.push(n);const e=getDepth.call(t,n,i);t.depths.push(e);}return t}function sortAscending(t){for(let e=t.cutoff;e>0;e--)for(let n=0;n<t.tree.length;n++)t.depths[n]===e&&t.pyramid.push(t.tree[n]);return t.tree=null,t}function getDepth(t,e){const n=this,i=n.tree[e-1]||null;if(t.parentElement===i)return n.depth+=1,n.stack.push(e-1),n.depth>n.cutoff&&(n.cutoff=n.depth),n.depth;if(t.previousElementSibling===i)return n.depth;for(let e=n.stack.length;e>=0;e--){const i=n.stack[e];n.tree[i]===t.parentElement&&(n.depth=n.depths[i]+1,n.stack=n.stack.slice(0,e+1));}return n.depth}function multiPassFilter(t){for(t.pyramid.forEach(stripBlockComments),t.root.querySelectorAll("style").forEach(filterWinningMediaQueries);0!==t.delta;)t.delta=0,t.pyramid.forEach(filterWinningInlineStyles.bind(t));return t}function stripBlockComments(t){const e=t.getAttribute("style");cssBlockCommentRegex.test(e)&&t.setAttribute("style",e.replace(cssBlockCommentRegex,""));}function filterWinningMediaQueries(t){if(t.media&&!globalThis.matchMedia(t.media).matches)return void t.parentElement.removeChild(t);if(!t.textContent.includes("@media"))return;const e=/@media([^{]+)\{((?:(?!\}\s*\})[\s\S])*\})\s*\}/;let n;for(;n=e.exec(t.textContent);){const e=n[1].trim(),i=n[2].trim();globalThis.matchMedia(e).matches?t.textContent=t.textContent.replace(n[0],i):t.textContent=t.textContent.replace(n[0],"");}}function filterWinningInlineStyles(t){if(!t.attributes.style)return;const e=new Styles(t,this);this.delta+=e.inline.cssText.length;const n={"animation-duration":"","transition-duration":""};for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)){if(!n[t])continue;n[t]=e.inline.getPropertyValue(t),e.inline.setProperty(t,"0s");}tokenizeCssTextDeclarations(e.inline.cssText).map(getCssTextProperty).sort(compareHyphenCount).forEach(spliceCssTextDeclaration.bind(e));for(const t in n)n[t].length&&e.inline.setProperty(t,n[t]);this.delta-=e.inline.cssText.length,""===t.getAttribute("style")&&t.removeAttribute("style");}function tokenizeCssTextDeclarations(t){return t.replace(/;\s*$/,"").split(cssDeclarationColonRegex)}function getCssTextProperty(t){return t.slice(0,t.indexOf(":"))}function compareHyphenCount(t,e){const n=t=>/^--\b/.test(t),i=t=>/^-\b/.test(t);return 64*(n(t)&!n(e))|32*(i(t)&!i(e))|Math.min(e.split("-").length-t.split("-").length,31)}function spliceCssTextDeclaration(t){if("width"===t||"height"===t)return;if("animation-duration"===t||"transition-duration"===t)return;const e=this.inline.getPropertyValue(t),n=tokenizeCssTextDeclarations(this.inline.cssText),i=n.findIndex((e=>t===getCssTextProperty(e)));-1!==i&&(this.inline.cssText=n.filter(((t,e)=>e!==i)).join("; ")+";",e!==this.computed.getPropertyValue(t)&&(this.inline.cssText=n.join("; ")+";"));}function unstageClone(t){return t.parent&&t.parent.insertBefore(t.root,t.sibling),t.sandbox&&t.sandbox.parentElement&&contentElement.removeChild(t.sandbox),t.sandbox&&(t.self=null,t.sandbox=null),t.root}

	return src;

}));
